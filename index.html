<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ± è²“å’ªè¨˜äº‹æœ¬</title>
    <!-- å¼•å…¥ Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <!-- å¼•å…¥æ‰‹å¯«é¢¨ Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Comic+Neue:wght@700&family=Yomogi&display=swap" rel="stylesheet">
    
    <!-- PWA Manifest & iOS æœ€ä½³åŒ– -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#fdfaf6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="è²“å’ªè¨˜äº‹">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ±</text></svg>">

    <style>
        body {
            font-family: 'Yomogi', 'Comic Neue', 'PingFang TC', 'Microsoft JhengHei', 'Segoe UI', sans-serif;
            background-color: #fdfaf6;
            background-image: radial-gradient(#cbd5e1 1.5px, transparent 1.5px);
            background-size: 20px 20px;
            -webkit-tap-highlight-color: transparent;
        }
        
        ::-webkit-scrollbar { width: 0px; background: transparent; }

        /* --- å¡—é´‰é¢¨æ ¼æ ¸å¿ƒ CSS --- */
        .doodle-box {
            border: 3px solid #1f2937;
            border-radius: 255px 15px 225px 15px / 15px 225px 15px 255px;
            box-shadow: 4px 4px 0px #1f2937;
            background-color: white;
        }
        
        .doodle-item {
            border: 2px solid #1f2937;
            border-radius: 15px 225px 15px 255px / 255px 15px 225px 15px;
            box-shadow: 2px 3px 0px #1f2937;
            background-color: white;
        }

        .doodle-btn {
            border: 2px solid #1f2937;
            border-radius: 225px 15px 255px 15px / 15px 255px 15px 225px;
            box-shadow: 2px 2px 0px #1f2937;
            transition: all 0.1s ease;
        }
        
        .doodle-btn:active {
            transform: translate(2px, 2px);
            box-shadow: 0px 0px 0px #1f2937;
        }

        input[type="radio"]:checked + label.tag-urgent { background-color: #f9a8d4; font-weight: bold; transform: translate(1px, 1px); box-shadow: 1px 1px 0px #1f2937; }
        input[type="radio"]:checked + label.tag-slow { background-color: #93c5fd; font-weight: bold; transform: translate(1px, 1px); box-shadow: 1px 1px 0px #1f2937; }

        input[type="checkbox"] {
            appearance: none; width: 1.25rem; height: 1.25rem;
            border: 2px solid #1f2937; border-radius: 4px; background: #fff; position: relative; cursor: pointer;
            border-radius: 255px 15px 225px 15px / 15px 225px 15px 255px;
        }
        input[type="checkbox"]:checked::after {
            content: 'âœ”'; position: absolute; top: -6px; left: 1px; font-size: 18px; color: #e11d48; font-weight: 900;
        }

        .doodle-input { border-bottom: 2px dashed #9ca3af; background: transparent; }
        .doodle-input:focus { border-bottom: 2px solid #f472b6; }

        .app-container { max-width: 480px; margin: 0 auto; min-height: 100vh; background: transparent; }
    </style>
</head>
<body class="text-gray-800 font-bold">

<!-- è²“å’ªé¼“å‹µ Toast æç¤ºæ¡† -->
<div id="cat-toast" class="doodle-box fixed top-24 left-1/2 transform -translate-x-1/2 px-5 py-3 text-pink-600 font-bold z-50 transition-all duration-300 opacity-0 pointer-events-none scale-95 flex items-center gap-2 w-max max-w-[90%] text-base md:text-xl">
</div>

<div class="app-container relative flex flex-col h-screen overflow-hidden">
    
    <!-- Header å€å¡Š -->
    <header class="doodle-box bg-yellow-200 p-3 sm:p-4 z-10 flex justify-between items-center relative mx-3 mt-3 mb-2">
        <h1 class="text-xl sm:text-2xl font-extrabold text-gray-800 tracking-wide flex items-center gap-2">
            <i class="ph-fill ph-cat text-2xl sm:text-3xl text-pink-500"></i> è²“å’ªè¨˜äº‹æœ¬
        </h1>
        <div class="flex gap-2">
            <button id="install-btn" onclick="openInstallModal()" class="doodle-btn bg-white text-pink-500 p-1.5 sm:p-2 hidden items-center justify-center" title="å®‰è£åˆ°æ‰‹æ©Ÿ">
                <i class="ph-bold ph-device-mobile text-lg text-gray-800"></i>
            </button>
            <button onclick="openDataModal()" class="doodle-btn bg-white text-gray-500 p-1.5 sm:p-2 flex items-center justify-center" title="è³‡æ–™ç®¡ç†">
                <i class="ph-bold ph-gear text-lg text-gray-800"></i>
            </button>
        </div>
    </header>

    <!-- å…§å®¹æ²å‹•å€ -->
    <main class="flex-1 overflow-y-auto p-3 space-y-4 pb-24">
        
        <!-- æ–°å¢è¨˜äº‹å€å¡Š -->
        <section class="doodle-box bg-white p-3">
            <div class="flex items-center gap-2 mb-3 relative">
                <input type="text" id="task-input" placeholder="æœ‰ä»€éº¼äº‹è¦è¨˜ä¸‹ä¾†å–µï¼ŸğŸ¾" 
                       class="w-full doodle-input py-2 px-2 focus:ring-0 outline-none text-base pr-10 text-gray-700">
                <button onclick="startVoiceRecognition()" id="mic-btn" class="absolute right-0 text-xl p-1.5 hover:scale-110 transition flex items-center justify-center text-pink-500" title="èªéŸ³è¼¸å…¥">
                    <i class="ph-fill ph-microphone-stage"></i>
                </button>
            </div>
            
            <div class="flex gap-2 items-stretch h-10">
                <div class="w-1/4">
                    <input type="radio" name="task-tag" id="tag-urgent" value="urgent" class="hidden" checked>
                    <label for="tag-urgent" class="tag-urgent doodle-btn bg-gray-50 h-full flex items-center justify-center text-center text-gray-700 cursor-pointer text-[12px] sm:text-sm font-bold leading-tight">ğŸ’–ç·Šæ€¥</label>
                </div>
                <div class="w-1/4">
                    <input type="radio" name="task-tag" id="tag-slow" value="slow" class="hidden">
                    <label for="tag-slow" class="tag-slow doodle-btn bg-gray-50 h-full flex items-center justify-center text-center text-gray-700 cursor-pointer text-[12px] sm:text-sm font-bold leading-tight">ğŸ’™æ…¢æ…¢</label>
                </div>
                <div class="w-2/4">
                    <button onclick="addTask()" class="h-full w-full doodle-btn bg-yellow-300 text-gray-800 font-extrabold flex justify-center items-center gap-1 text-sm hover:bg-yellow-400">
                        <i class="ph-bold ph-pencil text-lg"></i> <span>å¯«ä¸‹ä¾†</span>ğŸ¾
                    </button>
                </div>
            </div>
        </section>

        <!-- è¨˜äº‹åˆ—è¡¨å€å¡Š -->
        <div class="space-y-4 relative z-0">
            <!-- ç·Šæ€¥ -->
            <div class="doodle-box bg-pink-50 p-3">
                <h2 class="text-gray-800 text-base font-bold mb-2 flex items-center gap-1">
                    <span class="bg-pink-300 px-2 py-0.5 rounded-md border-2 border-gray-800 shadow-[1px_1px_0px_#1f2937] transform -rotate-2 inline-block"><i class="ph-bold ph-heart"></i> ç·Šæ€¥ä»»å‹™</span>
                </h2>
                <ul id="list-urgent" class="space-y-2.5"></ul>
            </div>
            
            <!-- æ…¢æ…¢ä¾† -->
            <div class="doodle-box bg-blue-50 p-3">
                <h2 class="text-gray-800 text-base font-bold mb-2 flex items-center gap-1">
                    <span class="bg-blue-300 px-2 py-0.5 rounded-md border-2 border-gray-800 shadow-[1px_1px_0px_#1f2937] transform rotate-1 inline-block"><i class="ph-bold ph-coffee"></i> æ…¢æ…¢ä¾†</span>
                </h2>
                <ul id="list-slow" class="space-y-2.5"></ul>
            </div>

            <!-- å·²å®Œæˆå€å¡Š -->
            <div class="doodle-box bg-gray-100 p-3">
                <h2 class="text-gray-600 text-base font-bold mb-2 flex items-center gap-1">
                    <span class="bg-gray-300 px-2 py-0.5 rounded-md border-2 border-gray-600 border-dashed inline-block"><i class="ph-bold ph-check-circle"></i> æå®šå•¦ï¼</span>
                </h2>
                <ul id="list-completed" class="space-y-2.5"></ul>
            </div>
        </div>
    </main>

    <!-- ä½œè€…æ¨™è¨˜ -->
    <div class="absolute bottom-1 right-3 text-[12px] text-gray-500 font-extrabold pointer-events-none z-0 transform -rotate-2">
        Made by TeacherFox ğŸ¦Š
    </div>

    <!-- PWA å®‰è£æ•™å­¸ Modal -->
    <div id="install-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
        <div class="doodle-box bg-white p-6 max-w-sm w-full relative">
            <button onclick="closeInstallModal()" class="absolute top-3 right-3 text-gray-800 text-2xl hover:scale-110 transition"><i class="ph-bold ph-x"></i></button>
            <h3 class="text-xl font-bold text-center text-gray-800 mb-4 flex justify-center items-center gap-2">
                <i class="ph-bold ph-device-mobile text-pink-500"></i> è£åˆ°æ‰‹æ©Ÿè£¡å–µ
            </h3>
            <div id="ios-instructions" class="hidden space-y-4 text-center">
                <p class="text-gray-800 font-bold text-lg bg-yellow-200 inline-block px-2 transform -rotate-1 border border-gray-800">ğŸ Apple iOS ç”¨æˆ¶</p>
                <div class="text-left space-y-2 text-gray-800 doodle-box bg-gray-50 p-3 text-sm">
                    <p>1. é»æ“Š Safari ç€è¦½å™¨ä¸‹æ–¹çš„åˆ†äº«åœ–ç¤ºï¼š<br><span class="inline-flex items-center justify-center doodle-item bg-white w-7 h-7 mt-1"><i class="ph-bold ph-export text-blue-500 text-lg"></i></span></p>
                    <p>2. å¾€ä¸‹æ»‘å‹•ï¼Œé¸æ“‡ <span class="font-bold doodle-item bg-white px-2 py-0.5 inline-block">â• åŠ å…¥ä¸»ç•«é¢</span></p>
                </div>
            </div>
            <div id="android-instructions" class="hidden space-y-4 text-center">
                <p class="text-gray-800 font-bold text-lg bg-yellow-200 inline-block px-2 transform -rotate-1 border border-gray-800">ğŸ¤– Android ç”¨æˆ¶</p>
                <div class="text-left space-y-2 text-gray-800 doodle-box bg-gray-50 p-3 text-sm">
                    <p>1. é»æ“Šç€è¦½å™¨å³ä¸Šè§’çš„é¸å–®ï¼š<br><span class="inline-flex items-center justify-center doodle-item bg-white w-7 h-7 mt-1"><i class="ph-bold ph-dots-three-vertical text-gray-800 text-lg"></i></span></p>
                    <p>2. é¸æ“‡ <span class="font-bold doodle-item bg-white px-2 py-0.5 inline-block">åŠ åˆ°ä¸»ç•«é¢</span></p>
                </div>
            </div>
            <button onclick="closeInstallModal()" class="mt-6 w-full doodle-btn bg-pink-300 text-gray-800 font-bold py-2.5 hover:bg-pink-400 transition">æˆ‘çŸ¥é“äº†å–µï¼ğŸ¾</button>
        </div>
    </div>

    <!-- ä¿®æ”¹è¨˜äº‹ Modal -->
    <div id="edit-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
        <div class="doodle-box bg-white p-6 max-w-sm w-full relative">
            <h3 class="text-lg font-bold text-center text-gray-800 mb-4 flex justify-center items-center gap-2 bg-yellow-200 mx-auto w-max px-3 border border-gray-800 transform rotate-1">
                <i class="ph-bold ph-pencil-simple text-pink-500"></i> ä¿®æ”¹å¡—é´‰å–µ
            </h3>
            <textarea id="edit-task-input" rows="3" placeholder="è«‹è¼¸å…¥è¨˜äº‹å…§å®¹..." class="w-full doodle-item bg-gray-50 py-3 px-4 outline-none text-base mb-4 resize-none"></textarea>
            <input type="hidden" id="edit-task-id">
            <div class="flex gap-3">
                <button onclick="closeEditModal()" class="flex-1 doodle-btn bg-gray-200 text-gray-800 font-bold py-2 hover:bg-gray-300 transition">ç®—äº†</button>
                <button onclick="saveEditTask()" class="flex-1 doodle-btn bg-pink-400 text-white font-bold py-2 hover:bg-pink-500 transition">é‡ç•«å¥½æƒ¹</button>
            </div>
        </div>
    </div>

    <!-- åˆªé™¤ç¢ºèª Modal -->
    <div id="delete-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
        <div class="doodle-box bg-white p-6 max-w-sm w-full relative">
            <h3 class="text-lg font-bold text-center text-gray-800 mb-4 flex justify-center items-center gap-2 bg-yellow-200 mx-auto w-max px-3 border border-gray-800 transform -rotate-1">
                <i class="ph-bold ph-warning-circle text-red-500"></i> ç¢ºå®šè¦åˆªé™¤å–µï¼ŸğŸ™€
            </h3>
            <p class="text-center text-gray-600 font-bold mb-6">é€™ç­†è¨˜äº‹åˆªé™¤å¾Œå°±æ‰¾ä¸å›ä¾†äº†å–µï¼</p>
            <input type="hidden" id="delete-task-id">
            <div class="flex gap-3">
                <button onclick="closeDeleteModal()" class="flex-1 doodle-btn bg-gray-200 text-gray-800 font-bold py-2 hover:bg-gray-300 transition">æ‰‹æ»‘äº†å–µ</button>
                <button onclick="confirmDeleteTask()" class="flex-1 doodle-btn bg-red-400 text-white font-bold py-2 hover:bg-red-500 transition">åˆªæ‰æƒ¹</button>
            </div>
        </div>
    </div>

    <!-- è³‡æ–™ç®¡ç† Modal -->
    <div id="data-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
        <div class="doodle-box bg-white p-6 max-w-sm w-full relative">
            <button onclick="closeDataModal()" class="absolute top-3 right-3 text-gray-800 text-2xl hover:scale-110 transition"><i class="ph-bold ph-x"></i></button>
            <h3 class="text-xl font-bold text-center text-gray-800 mb-6 flex justify-center items-center gap-2">
                <i class="ph-bold ph-gear text-pink-500"></i> å·¥å…·ç®±
            </h3>
            <div class="space-y-4">
                <button onclick="exportData()" class="w-full doodle-btn bg-blue-200 text-gray-800 font-bold py-3 hover:bg-blue-300 transition flex items-center justify-center gap-2">
                    <i class="ph-bold ph-download-simple text-xl"></i> åŒ¯å‡ºå‚™ä»½ (æ‰“åŒ…å¸¶èµ°)
                </button>
                <label class="w-full doodle-btn bg-green-200 text-gray-800 font-bold py-3 hover:bg-green-300 transition flex items-center justify-center gap-2 cursor-pointer">
                    <i class="ph-bold ph-upload-simple text-xl"></i> åŒ¯å…¥å‚™ä»½ (è®€å–å›ä¾†)
                    <input type="file" id="import-file" class="hidden" accept=".json" onchange="importData(event)">
                </label>
            </div>
        </div>
    </div>
</div>

<script>
    // --- 1. è³‡æ–™èˆ‡ç‹€æ…‹ç®¡ç† ---
    let tasks = JSON.parse(localStorage.getItem('catTasks')) || [];
    let expandedState = { urgent: false, slow: false, completed: false };
    let expandedTextSet = new Set();
    let deferredPrompt;

    // è²“å’ªé¼“å‹µèªéŒ„ (å®Œæˆ)
    const catEncouragements = [ "ä½ å¤ªæ£’äº†å–µï¼ğŸ¾", "åšçš„å¥½ï¼çå‹µä¸€å€‹ç½ç½å–µ~ğŸŸ", "å–µæ˜Ÿäººç‚ºä½ é©•å‚²ï¼âœ¨", "å¤ªç¥å•¦ï¼è²“è²“å´‡æ‹œä½ å–µğŸ™€" ];
    // è²“å’ªé¼“å‹µèªéŒ„ (å–æ¶ˆæ‰“å‹¾/é‡åš)
    const catUncheckEncouragements = [ "æ²’é—œä¿‚å–µï¼Œæˆ‘å€‘é‡æ–°å†ä¾†ï¼ğŸ¾", "æœ¬å–µé™ªä½ ä¸€èµ·é‡æ–°æŒ‘æˆ°å–µï¼ğŸ’ª", "ä¼‘æ¯ä¸€ä¸‹å†å‡ºç™¼å–µï¼â˜•", "ä¸æ€¥ä¸æ€¥ï¼Œæ…¢æ…¢ä¾†å–µ~ğŸ¢" ];

    // --- æ ¸å¿ƒï¼šæ™ºèƒ½èƒå–æ–‡å­—ä¸­çš„æ—¥æœŸèˆ‡æ™‚é–“ (ç°¡æ˜“ NLP) ---
    function extractDateFromText(text) {
        const now = new Date();
        let targetDate = null;
        let hasTime = false;

        if (text.includes("ä»Šå¤©")) { targetDate = new Date(); }
        else if (text.includes("æ˜å¤©")) { targetDate = new Date(now); targetDate.setDate(now.getDate() + 1); }
        else if (text.includes("å¾Œå¤©")) { targetDate = new Date(now); targetDate.setDate(now.getDate() + 2); }
        else if (text.includes("å¤§å¾Œå¤©")) { targetDate = new Date(now); targetDate.setDate(now.getDate() + 3); }
        
        if (!targetDate) {
            const weekMatch = text.match(/(ä¸‹é€±|ä¸‹æ˜ŸæœŸ|æ˜ŸæœŸ|é€±|ç¦®æ‹œ)([ä¸€äºŒä¸‰å››äº”å…­æ—¥å¤©])/);
            if (weekMatch) {
                const dayMap = { 'ä¸€': 1, 'äºŒ': 2, 'ä¸‰': 3, 'å››': 4, 'äº”': 5, 'å…­': 6, 'æ—¥': 0, 'å¤©': 0 };
                const targetDay = dayMap[weekMatch[2]];
                const currentDay = now.getDay();
                let daysToAdd = targetDay - currentDay;
                if (daysToAdd <= 0 || weekMatch[1].includes("ä¸‹")) { daysToAdd += 7; }
                targetDate = new Date(now);
                targetDate.setDate(now.getDate() + daysToAdd);
            }
        }

        if (!targetDate) {
            const dateMatch = text.match(/(\d{1,2})\s*[æœˆ/]\s*(\d{1,2})\s*(æ—¥|è™Ÿ)?/);
            if (dateMatch) {
                const month = parseInt(dateMatch[1]) - 1; 
                const day = parseInt(dateMatch[2]);
                targetDate = new Date(now.getFullYear(), month, day);
                if (targetDate.getTime() < new Date(now.setHours(0,0,0,0)).getTime()) {
                    targetDate.setFullYear(targetDate.getFullYear() + 1);
                }
            }
        }

        const timeMatch = text.match(/(å‡Œæ™¨|æ—©ä¸Š|ä¸Šåˆ|ä¸­åˆ|ä¸‹åˆ|æ™šä¸Š)?\s*(\d{1,2})\s*(?:é»|æ™‚|:)\s*(åŠ|\d{1,2}åˆ†?)?/);
        if (timeMatch) {
            let period = timeMatch[1];
            let hour = parseInt(timeMatch[2]);
            let minuteStr = timeMatch[3];
            let minute = 0;

            if (minuteStr === 'åŠ') minute = 30;
            else if (minuteStr) minute = parseInt(minuteStr.replace('åˆ†', ''));

            if (period) {
                if ((period === 'ä¸‹åˆ' || period === 'æ™šä¸Š') && hour < 12) hour += 12;
                else if ((period === 'å‡Œæ™¨' || period === 'æ—©ä¸Š' || period === 'ä¸Šåˆ') && hour === 12) hour = 0;
            }

            if (!targetDate) targetDate = new Date();
            targetDate.setHours(hour, minute, 0, 0);
            hasTime = true;
        }

        if (targetDate) {
            if (!hasTime) targetDate.setHours(23, 59, 59, 999); 
            
            let formatted = `${targetDate.getMonth() + 1}/${targetDate.getDate()}`;
            if (hasTime) {
                let h = targetDate.getHours().toString().padStart(2, '0');
                let m = targetDate.getMinutes().toString().padStart(2, '0');
                formatted += ` ${h}:${m}`;
            }
            return { timestamp: targetDate.getTime(), formatted: formatted };
        }
        return null;
    }

    // --- åˆå§‹åŒ– ---
    document.addEventListener('DOMContentLoaded', () => {
        renderTasks();
        setupPWA();
        checkInstallState(); 
    });

    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.matchMedia('(display-mode: fullscreen)').matches || window.navigator.standalone;
        if (!isStandalone) {
            const btn = document.getElementById('install-btn');
            btn.classList.remove('hidden');
            btn.classList.add('flex');
            btn.style.display = 'flex';
        }
    });

    function checkInstallState() {
        const isStandalone = window.matchMedia('(display-mode: standalone)').matches || 
                             window.matchMedia('(display-mode: fullscreen)').matches ||
                             window.navigator.standalone || document.referrer.includes('android-app://');
        
        const installBtn = document.getElementById('install-btn');
        if (isStandalone) {
            installBtn.style.display = 'none';
        } else {
            const ua = navigator.userAgent.toLowerCase();
            const isIOS = /ipad|iphone|ipod/.test(ua) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
            if (isIOS) {
                installBtn.classList.remove('hidden');
                installBtn.classList.add('flex');
                installBtn.style.display = 'flex';
            }
        }
    }

    window.addEventListener('appinstalled', () => { document.getElementById('install-btn').style.display = 'none'; });

    function saveTasks() { localStorage.setItem('catTasks', JSON.stringify(tasks)); }

    function showCatToast(msg) {
        const toast = document.getElementById('cat-toast');
        toast.innerHTML = `<i class="ph-fill ph-cat text-3xl text-pink-500"></i> <span class="text-gray-800 leading-snug">${msg}</span>`;
        toast.classList.remove('opacity-0', 'scale-95', 'pointer-events-none');
        toast.classList.add('opacity-100', 'scale-100', '-translate-y-2');
        
        setTimeout(() => {
            toast.classList.remove('opacity-100', 'scale-100', '-translate-y-2');
            toast.classList.add('opacity-0', 'scale-95', 'pointer-events-none');
        }, 3500);
    }

    // --- è¨˜äº‹æ“ä½œ ---
    function addTask() {
        const input = document.getElementById('task-input');
        const text = input.value.trim();
        if (!text) return alert('è«‹è¼¸å…¥è¨˜äº‹å…§å®¹å–µï¼ğŸ¾');

        const tag = document.querySelector('input[name="task-tag"]:checked').value;
        const extractedDateInfo = extractDateFromText(text);

        const newTask = {
            id: Date.now().toString(),
            text: text,
            tag: tag,
            isCompleted: false,
            createdAt: Date.now(),
            dueDate: extractedDateInfo ? extractedDateInfo.timestamp : null,
            dateText: extractedDateInfo ? extractedDateInfo.formatted : null
        };

        tasks.push(newTask);
        saveTasks();
        input.value = ''; 
        renderTasks();
    }

    // è§¸ç™¼åˆªé™¤ç¢ºèªè¦–çª—
    function deleteTask(id) {
        document.getElementById('delete-task-id').value = id;
        document.getElementById('delete-modal').classList.remove('hidden');
    }

    // é—œé–‰åˆªé™¤ç¢ºèªè¦–çª—
    function closeDeleteModal() {
        document.getElementById('delete-modal').classList.add('hidden');
    }

    // ç¢ºèªåŸ·è¡Œåˆªé™¤
    function confirmDeleteTask() {
        const id = document.getElementById('delete-task-id').value;
        tasks = tasks.filter(t => String(t.id) !== String(id));
        saveTasks();
        renderTasks();
        closeDeleteModal();
    }

    function editTask(id) {
        const task = tasks.find(t => String(t.id) === String(id));
        if (!task) return;
        document.getElementById('edit-task-id').value = task.id;
        document.getElementById('edit-task-input').value = task.text;
        document.getElementById('edit-modal').classList.remove('hidden');
    }

    function closeEditModal() { document.getElementById('edit-modal').classList.add('hidden'); }

    function saveEditTask() {
        const id = document.getElementById('edit-task-id').value;
        const newText = document.getElementById('edit-task-input').value.trim();
        if (newText) {
            const task = tasks.find(t => String(t.id) === String(id));
            if (task) {
                task.text = newText;
                const extractedDateInfo = extractDateFromText(newText);
                task.dueDate = extractedDateInfo ? extractedDateInfo.timestamp : null;
                task.dateText = extractedDateInfo ? extractedDateInfo.formatted : null;
                saveTasks();
                renderTasks();
            }
        }
        closeEditModal();
    }

    function toggleComplete(id) {
        const task = tasks.find(t => String(t.id) === String(id));
        if (task) {
            task.isCompleted = !task.isCompleted;
            if (task.isCompleted) {
                showCatToast(catEncouragements[Math.floor(Math.random() * catEncouragements.length)]);
            } else {
                showCatToast(catUncheckEncouragements[Math.floor(Math.random() * catUncheckEncouragements.length)]);
            }
            saveTasks();
            renderTasks();
        }
    }

    function changeTag(id, newTag) {
        const task = tasks.find(t => String(t.id) === String(id));
        if (task) { task.tag = newTag; saveTasks(); renderTasks(); }
    }

    function toggleExpand(category) { expandedState[category] = !expandedState[category]; renderTasks(); }
    function toggleTextExpand(id) { if (expandedTextSet.has(id)) expandedTextSet.delete(id); else expandedTextSet.add(id); renderTasks(); }

    function renderTasks() {
        document.getElementById('list-urgent').innerHTML = '';
        document.getElementById('list-slow').innerHTML = '';
        document.getElementById('list-completed').innerHTML = '';

        const sortedTasks = [...tasks].sort((a, b) => {
            if (a.dueDate && b.dueDate) return a.dueDate - b.dueDate;
            if (a.dueDate && !b.dueDate) return -1;
            if (!a.dueDate && b.dueDate) return 1;
            return b.createdAt - a.createdAt;
        });

        const grouped = {
            urgent: sortedTasks.filter(t => !t.isCompleted && t.tag === 'urgent'),
            slow: sortedTasks.filter(t => !t.isCompleted && t.tag === 'slow'),
            completed: sortedTasks.filter(t => t.isCompleted)
        };

        const createLi = (task) => {
            const li = document.createElement('li');
            li.className = `doodle-item py-2 px-3 flex items-start gap-2.5 transition-all ${task.isCompleted ? 'bg-gray-50 opacity-80' : 'bg-white'}`;
            
            let tagBg = task.tag === 'urgent' ? 'bg-pink-200 text-gray-800' : 'bg-blue-200 text-gray-800';
            const isTextExpanded = expandedTextSet.has(task.id);
            const clampClass = isTextExpanded ? '' : 'line-clamp-2';

            // æº–å‚™æ—¥æœŸæ¨™ç±¤
            let dateBadge = '';
            if (task.dateText && !task.isCompleted) {
                // ç§»é™¤åŸæœ‰çš„ mt-1ï¼Œå°‡ç”± flex å®¹å™¨è™•ç†é–“è·
                dateBadge = `<span class="inline-block bg-yellow-100 text-gray-800 text-[11px] font-bold px-1.5 py-0.5 rounded border border-gray-800 transform rotate-1 shadow-[1px_1px_0px_#1f2937]">ğŸ“… ${task.dateText} æœŸé™</span>`;
            }

            li.innerHTML = `
                <!-- å·¦æ¬„ï¼šæ ¸å–æ–¹å¡Šèˆ‡æ¨™ç±¤ -->
                <div class="flex flex-col items-center gap-1.5 flex-shrink-0 pt-0.5 w-[3.5rem]">
                    <input type="checkbox" onchange="toggleComplete('${task.id}')" ${task.isCompleted ? 'checked' : ''} class="w-5 h-5 m-0">
                    <div class="relative w-full">
                        <select onchange="changeTag('${task.id}', this.value)" class="appearance-none w-full text-center cursor-pointer text-[10px] font-bold py-0.5 border-2 border-gray-800 focus:outline-none focus:bg-yellow-200 ${tagBg} doodle-btn" style="box-shadow: 1px 1px 0px #1f2937; border-radius: 4px;">
                            <option value="urgent" ${task.tag === 'urgent' ? 'selected' : ''}>ğŸ’–ç·Šæ€¥</option>
                            <option value="slow" ${task.tag === 'slow' ? 'selected' : ''}>ğŸ’™æ…¢æ…¢</option>
                        </select>
                        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center pr-0.5">
                            <i class="ph-bold ph-caret-down text-[8px] text-gray-800"></i>
                        </div>
                    </div>
                </div>

                <!-- ä¸­æ¬„ï¼šç­†è¨˜å…§å®¹èˆ‡é™„å±¬æ¨™ç±¤(æ•´åˆè‡³åŒä¸€æ’) -->
                <div class="flex-1 min-w-0 flex flex-col justify-start">
                    <div id="text-${task.id}" class="font-bold break-words text-base sm:text-lg leading-snug ${task.isCompleted ? 'text-gray-400 line-through' : 'text-gray-800'} ${clampClass}">
                        ${task.text}
                    </div>
                    
                    <!-- å°‡ã€Œé¡¯ç¤ºæ›´å¤šã€èˆ‡ã€Œæ—¥æœŸæ¨™ç±¤ã€è£é€²åŒä¸€å€‹å½ˆæ€§å®¹å™¨ï¼Œç¢ºä¿æ’åœ¨åŒä¸€æ’ -->
                    <div class="flex items-center flex-wrap gap-2 mt-1">
                        <button id="more-btn-${task.id}" onclick="toggleTextExpand('${task.id}')" class="hidden shrink-0 text-left text-[11px] font-extrabold text-pink-500 hover:text-pink-600 w-max tracking-wide bg-yellow-100 px-1 border border-gray-800 transform -rotate-1">
                            ${isTextExpanded ? 'æ”¶èµ· ğŸ”¼' : 'é¡¯ç¤ºæ›´å¤š ğŸ”½'}
                        </button>
                        ${dateBadge}
                    </div>
                </div>
                
                <!-- å³æ¬„ï¼šæŒ‰éˆ•å€ -->
                <div class="flex flex-col items-center gap-1 flex-shrink-0 pt-0">
                    <button onclick="editTask('${task.id}')" class="text-gray-600 hover:text-blue-500 transition p-0.5 hover:scale-110" title="ä¿®æ”¹"><i class="ph-bold ph-pencil-simple text-base sm:text-lg"></i></button>
                    <!-- æ”¹ç‚ºè§¸ç™¼ç¢ºèªåˆªé™¤è¦–çª— -->
                    <button onclick="deleteTask('${task.id}')" class="text-gray-600 hover:text-red-500 transition p-0.5 hover:scale-110" title="åˆªé™¤"><i class="ph-bold ph-trash text-base sm:text-lg"></i></button>
                </div>
            `;
            return li;
        };

        ['urgent', 'slow', 'completed'].forEach(category => {
            const listEl = document.getElementById(`list-${category}`);
            const items = grouped[category];
            
            if (items.length === 0) {
                listEl.innerHTML = `<li class="text-center text-base py-2 text-gray-500 font-bold border-2 border-dashed border-gray-400 rounded-lg bg-gray-50/50 transform rotate-1">æ²’æœ‰ä»»å‹™å–µ ğŸ¾</li>`;
                return;
            }

            const limit = 5;
            const isExpanded = expandedState[category];
            const displayItems = isExpanded ? items : items.slice(0, limit);

            displayItems.forEach(task => listEl.appendChild(createLi(task)));

            if (items.length > limit) {
                const btnLi = document.createElement('li');
                btnLi.className = 'text-center pt-2 pb-1';
                const remaining = items.length - limit;
                btnLi.innerHTML = `
                    <button onclick="toggleExpand('${category}')" class="doodle-btn text-[12px] font-bold text-gray-800 bg-white hover:bg-yellow-200 transition flex justify-center items-center gap-1 mx-auto px-4 py-1.5">
                        ${isExpanded ? '<i class="ph-bold ph-caret-up"></i> æ”¶èµ·æ¸…å–®' : `<i class="ph-bold ph-caret-down"></i> é‚„æœ‰ ${remaining} ç­†æ²’ç•«å®Œ`}
                    </button>
                `;
                listEl.appendChild(btnLi);
            }
        });

        requestAnimationFrame(() => {
            tasks.forEach(task => {
                const textEl = document.getElementById(`text-${task.id}`);
                const moreBtn = document.getElementById(`more-btn-${task.id}`);
                if (textEl && moreBtn) {
                    const isOverflowing = textEl.scrollHeight > textEl.clientHeight + 2;
                    const isExpanded = expandedTextSet.has(task.id);
                    if (isOverflowing || isExpanded) moreBtn.classList.remove('hidden');
                }
            });
        });
    }

    // --- èªéŸ³è¼¸å…¥ ---
    function startVoiceRecognition() {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognition) return alert('æŠ±æ­‰å–µï¼æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³è¾¨è­˜ ğŸ˜¿');

        const recognition = new SpeechRecognition();
        recognition.lang = 'zh-TW';
        recognition.interimResults = true; 
        recognition.maxAlternatives = 1;

        const micBtn = document.getElementById('mic-btn');
        const input = document.getElementById('task-input');
        micBtn.innerHTML = '<i class="ph-bold ph-ear"></i>';
        micBtn.classList.add('animate-bounce', 'text-pink-600');

        let originalText = input.value ? input.value + ' ' : '';
        recognition.start();

        recognition.onresult = (event) => {
            let interimTranscript = '';
            let finalTranscript = '';
            for (let i = event.resultIndex; i < event.results.length; ++i) {
                if (event.results[i].isFinal) finalTranscript += event.results[i][0].transcript;
                else interimTranscript += event.results[i][0].transcript;
            }
            input.value = (originalText + finalTranscript + interimTranscript).trim();
            if (finalTranscript) originalText = (originalText + finalTranscript + ' ');
        };

        recognition.onerror = (event) => console.error('èªéŸ³è¾¨è­˜éŒ¯èª¤:', event.error);
        recognition.onend = () => {
            micBtn.innerHTML = '<i class="ph-fill ph-microphone-stage"></i>';
            micBtn.classList.remove('animate-bounce', 'text-pink-600');
        };
    }

    // --- Modal èˆ‡ PWA ---
    function openDataModal() { document.getElementById('data-modal').classList.remove('hidden'); }
    function closeDataModal() { document.getElementById('data-modal').classList.add('hidden'); }
    function exportData() { /* ä¿æŒåŸåŠŸèƒ½ */
        if (tasks.length === 0) return alert('ç›®å‰æ²’æœ‰è¨˜äº‹å¯ä»¥åŒ¯å‡ºå–µï¼');
        const dataStr = JSON.stringify(tasks, null, 2);
        const blob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `cat-tasks-backup-${new Date().toISOString().slice(0,10)}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        closeDataModal();
    }
    function importData(event) { /* ä¿æŒåŸåŠŸèƒ½ */
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const importedTasks = JSON.parse(e.target.result);
                if (Array.isArray(importedTasks)) {
                    const existingIds = new Set(tasks.map(t => String(t.id)));
                    importedTasks.forEach(t => {
                        if (!existingIds.has(String(t.id))) {
                            if (t.isCompleted === undefined) t.isCompleted = false;
                            if (t.tag === 'normal') t.tag = 'slow';
                            tasks.push(t);
                        }
                    });
                    saveTasks();
                    renderTasks();
                    alert('åŒ¯å…¥æˆåŠŸå–µï¼ğŸ¾');
                    closeDataModal();
                } else { throw new Error('æ ¼å¼éŒ¯èª¤'); }
            } catch (err) { alert('åŒ¯å…¥å¤±æ•—ï¼Œè«‹ç¢ºèªæª”æ¡ˆæ ¼å¼å–µï¼ğŸ˜¿'); }
        };
        reader.readAsText(file);
        event.target.value = ''; 
    }

    function setupPWA() {
        if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js').catch(() => {});
    }

    async function openInstallModal() {
        if (deferredPrompt) {
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            if (outcome === 'accepted') { deferredPrompt = null; document.getElementById('install-btn').style.display = 'none'; }
            return;
        }
        const modal = document.getElementById('install-modal');
        const iosInst = document.getElementById('ios-instructions');
        const andInst = document.getElementById('android-instructions');
        
        const ua = navigator.userAgent.toLowerCase();
        const isIOS = /ipad|iphone|ipod/.test(ua) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
        
        iosInst.classList.add('hidden'); andInst.classList.add('hidden');
        if (isIOS) iosInst.classList.remove('hidden'); else andInst.classList.remove('hidden');
        modal.classList.remove('hidden');
    }

    function closeInstallModal() { document.getElementById('install-modal').classList.add('hidden'); }
</script>

</body>
</html>


