<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ± è²“å’ªè¨˜äº‹æœ¬</title>
    <!-- å¼•å…¥ Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <!-- å¼•å…¥æ‰‹å¯«é¢¨ Google Fonts (Comic Neue & Yomogi) -->
    <link href="https://fonts.googleapis.com/css2?family=Comic+Neue:wght@700&family=Yomogi&display=swap" rel="stylesheet">
    
    <!-- PWA Manifest -->
    <link id="manifest-link" rel="manifest" href="">
    <meta name="theme-color" content="#fdf2f8">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ±</text></svg>">

    <style>
        body {
            /* ç§»é™¤ cursiveï¼ŒåŠ ä¸Šç³»çµ±åŸç”Ÿé»‘é«”ï¼Œé¿å…ä¸­æ–‡å­—é‡åˆ°ç¼ºå­—æ™‚è®Šæˆæ¨™æ¥·é«” */
            font-family: 'Yomogi', 'Comic Neue', 'PingFang TC', 'Microsoft JhengHei', 'Segoe UI', sans-serif;
            background-color: #fdfaf6;
            /* ç­†è¨˜æœ¬ç¶²é»èƒŒæ™¯ */
            background-image: radial-gradient(#cbd5e1 1.5px, transparent 1.5px);
            background-size: 20px 20px;
            -webkit-tap-highlight-color: transparent;
        }
        
        ::-webkit-scrollbar {
            width: 0px;
            background: transparent;
        }

        /* --- å¡—é´‰é¢¨æ ¼æ ¸å¿ƒ CSS --- */
        .doodle-box {
            border: 3px solid #1f2937;
            border-radius: 255px 15px 225px 15px / 15px 225px 15px 255px;
            box-shadow: 4px 4px 0px #1f2937;
            background-color: white;
        }
        
        .doodle-item {
            border: 2px solid #1f2937;
            border-radius: 15px 225px 15px 255px / 255px 15px 225px 15px;
            box-shadow: 2px 3px 0px #1f2937;
            background-color: white;
        }

        .doodle-btn {
            border: 2px solid #1f2937;
            border-radius: 225px 15px 255px 15px / 15px 255px 15px 225px;
            box-shadow: 2px 2px 0px #1f2937;
            transition: all 0.1s ease;
        }
        
        .doodle-btn:active {
            transform: translate(2px, 2px);
            box-shadow: 0px 0px 0px #1f2937;
        }

        /* æ‰‹ç¹ªæ¨™ç±¤æŒ‰éˆ•é¸å–ç‹€æ…‹ */
        input[type="radio"]:checked + label.tag-urgent { 
            background-color: #f9a8d4; /* äº®ç²‰è‰² */
            font-weight: bold; 
            transform: translate(1px, 1px);
            box-shadow: 1px 1px 0px #1f2937;
        }
        input[type="radio"]:checked + label.tag-slow { 
            background-color: #93c5fd; /* äº®è—è‰² */
            font-weight: bold; 
            transform: translate(1px, 1px);
            box-shadow: 1px 1px 0px #1f2937;
        }

        /* æ‰‹ç¹ªé¢¨æ ¸å–æ–¹å¡Š (Checkbox) */
        input[type="checkbox"] {
            appearance: none;
            width: 1.25rem;
            height: 1.25rem;
            border: 2px solid #1f2937;
            border-radius: 4px;
            background: #fff;
            position: relative;
            cursor: pointer;
            border-radius: 255px 15px 225px 15px / 15px 225px 15px 255px;
        }
        input[type="checkbox"]:checked::after {
            content: 'âœ”';
            position: absolute;
            top: -6px;
            left: 1px;
            font-size: 18px;
            color: #e11d48; /* å½©è‰²ç­†ç´… */
            font-weight: 900;
        }

        /* æ‰‹ç¹ªé¢¨è¼¸å…¥æ¡†åº•ç·š */
        .doodle-input {
            border-bottom: 2px dashed #9ca3af;
            background: transparent;
        }
        .doodle-input:focus {
            border-bottom: 2px solid #f472b6;
        }

        .app-container {
            max-width: 480px;
            margin: 0 auto;
            min-height: 100vh;
            background: transparent; /* è®“ç­†è¨˜æœ¬åº•è‰²é€å‡ºä¾† */
        }
    </style>
</head>
<body class="text-gray-800 font-bold">

<!-- è²“å’ªé¼“å‹µ Toast æç¤ºæ¡† -->
<div id="cat-toast" class="doodle-box fixed top-24 left-1/2 transform -translate-x-1/2 px-5 py-3 text-pink-600 font-bold z-50 transition-all duration-300 opacity-0 pointer-events-none scale-95 flex items-center gap-2 w-max max-w-[90%] text-sm md:text-base">
</div>

<div class="app-container relative flex flex-col h-screen overflow-hidden">
    
    <!-- Header å€å¡Š (æ‰‹ç¹ªæ¨™é¡Œåˆ—) -->
    <header class="doodle-box bg-yellow-200 p-3 sm:p-4 z-10 flex justify-between items-center relative mx-3 mt-3 mb-2">
        <h1 class="text-xl sm:text-2xl font-extrabold text-gray-800 tracking-wide flex items-center gap-2">
            <i class="ph-fill ph-cat text-2xl sm:text-3xl text-pink-500"></i> è²“å’ªè¨˜äº‹æœ¬
        </h1>
        <div class="flex gap-2">
            <button id="install-btn" onclick="openInstallModal()" class="doodle-btn bg-white text-pink-500 p-1.5 sm:p-2 flex items-center justify-center" title="å®‰è£åˆ°æ‰‹æ©Ÿ">
                <i class="ph-bold ph-device-mobile text-lg text-gray-800"></i>
            </button>
            <button onclick="openDataModal()" class="doodle-btn bg-white text-gray-500 p-1.5 sm:p-2 flex items-center justify-center" title="è³‡æ–™ç®¡ç†">
                <i class="ph-bold ph-gear text-lg text-gray-800"></i>
            </button>
        </div>
    </header>

    <!-- å…§å®¹æ²å‹•å€ -->
    <main class="flex-1 overflow-y-auto p-3 space-y-4 pb-24">
        
        <!-- æ–°å¢è¨˜äº‹å€å¡Š (ç•«æ¿é¢¨æ ¼) -->
        <section class="doodle-box bg-white p-3">
            <div class="flex items-center gap-2 mb-3 relative">
                <input type="text" id="task-input" placeholder="æœ‰ä»€éº¼äº‹è¦è¨˜ä¸‹ä¾†å–µï¼ŸğŸ¾" 
                       class="w-full doodle-input py-2 px-2 focus:ring-0 outline-none text-base pr-10 text-gray-700">
                <button onclick="startVoiceRecognition()" id="mic-btn" class="absolute right-0 text-xl p-1.5 hover:scale-110 transition flex items-center justify-center text-pink-500" title="èªéŸ³è¼¸å…¥">
                    <i class="ph-fill ph-microphone-stage"></i>
                </button>
            </div>
            
            <div class="flex gap-2 items-stretch h-10">
                <div class="w-1/4">
                    <input type="radio" name="task-tag" id="tag-urgent" value="urgent" class="hidden" checked>
                    <label for="tag-urgent" class="tag-urgent doodle-btn bg-gray-50 h-full flex items-center justify-center text-center text-gray-700 cursor-pointer text-[12px] sm:text-sm font-bold leading-tight">ğŸ’–ç·Šæ€¥</label>
                </div>
                <div class="w-1/4">
                    <input type="radio" name="task-tag" id="tag-slow" value="slow" class="hidden">
                    <label for="tag-slow" class="tag-slow doodle-btn bg-gray-50 h-full flex items-center justify-center text-center text-gray-700 cursor-pointer text-[12px] sm:text-sm font-bold leading-tight">ğŸ’™æ…¢æ…¢</label>
                </div>
                <div class="w-2/4">
                    <!-- æ˜äº®çš„ç«¥è¶£é»ƒè‰²åŠ å…¥æŒ‰éˆ• -->
                    <button onclick="addTask()" class="h-full w-full doodle-btn bg-yellow-300 text-gray-800 font-extrabold flex justify-center items-center gap-1 text-sm hover:bg-yellow-400">
                        <i class="ph-bold ph-pencil text-lg"></i> <span>å¯«ä¸‹ä¾†</span>ğŸ¾
                    </button>
                </div>
            </div>
        </section>

        <!-- è¨˜äº‹åˆ—è¡¨å€å¡Š -->
        <div class="space-y-4 relative z-0">
            <!-- ç·Šæ€¥ -->
            <div class="doodle-box bg-pink-50 p-3">
                <h2 class="text-gray-800 text-base font-bold mb-2 flex items-center gap-1">
                    <span class="bg-pink-300 px-2 py-0.5 rounded-md border-2 border-gray-800 shadow-[1px_1px_0px_#1f2937] transform -rotate-2 inline-block"><i class="ph-bold ph-heart"></i> ç·Šæ€¥ä»»å‹™</span>
                </h2>
                <ul id="list-urgent" class="space-y-2.5"></ul>
            </div>
            
            <!-- æ…¢æ…¢ä¾† -->
            <div class="doodle-box bg-blue-50 p-3">
                <h2 class="text-gray-800 text-base font-bold mb-2 flex items-center gap-1">
                    <span class="bg-blue-300 px-2 py-0.5 rounded-md border-2 border-gray-800 shadow-[1px_1px_0px_#1f2937] transform rotate-1 inline-block"><i class="ph-bold ph-coffee"></i> æ…¢æ…¢ä¾†</span>
                </h2>
                <ul id="list-slow" class="space-y-2.5"></ul>
            </div>

            <!-- å·²å®Œæˆå€å¡Š -->
            <div class="doodle-box bg-gray-100 p-3">
                <h2 class="text-gray-600 text-base font-bold mb-2 flex items-center gap-1">
                    <span class="bg-gray-300 px-2 py-0.5 rounded-md border-2 border-gray-600 border-dashed inline-block"><i class="ph-bold ph-check-circle"></i> æå®šå•¦ï¼</span>
                </h2>
                <ul id="list-completed" class="space-y-2.5"></ul>
            </div>
        </div>
    </main>

    <!-- ä½œè€…æ¨™è¨˜ -->
    <div class="absolute bottom-1 right-3 text-[12px] text-gray-500 font-extrabold pointer-events-none z-0 transform -rotate-2">
        ğŸ–ï¸ Made by TeacherFox
    </div>

    <!-- PWA å®‰è£æ•™å­¸ Modal -->
    <div id="install-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
        <div class="doodle-box bg-white p-6 max-w-sm w-full relative">
            <button onclick="closeInstallModal()" class="absolute top-3 right-3 text-gray-800 text-2xl hover:scale-110 transition"><i class="ph-bold ph-x"></i></button>
            <h3 class="text-xl font-bold text-center text-gray-800 mb-4 flex justify-center items-center gap-2">
                <i class="ph-bold ph-device-mobile text-pink-500"></i> è£åˆ°æ‰‹æ©Ÿè£¡å–µ
            </h3>
            
            <!-- iOS èªªæ˜ -->
            <div id="ios-instructions" class="hidden space-y-4 text-center">
                <p class="text-gray-800 font-bold text-lg bg-yellow-200 inline-block px-2 transform -rotate-1 border border-gray-800">ğŸ Apple iOS ç”¨æˆ¶</p>
                <div class="text-left space-y-2 text-gray-800 doodle-box bg-gray-50 p-3 text-sm">
                    <p>1. é»æ“Š Safari ç€è¦½å™¨ä¸‹æ–¹çš„åˆ†äº«åœ–ç¤ºï¼š<br><span class="inline-flex items-center justify-center doodle-item bg-white w-7 h-7 mt-1"><i class="ph-bold ph-export text-blue-500 text-lg"></i></span></p>
                    <p>2. å¾€ä¸‹æ»‘å‹•ï¼Œé¸æ“‡ <span class="font-bold doodle-item bg-white px-2 py-0.5 inline-block">â• åŠ å…¥ä¸»ç•«é¢</span></p>
                </div>
            </div>

            <!-- Android èªªæ˜ -->
            <div id="android-instructions" class="hidden space-y-4 text-center">
                <p class="text-gray-800 font-bold text-lg bg-yellow-200 inline-block px-2 transform -rotate-1 border border-gray-800">ğŸ¤– Android ç”¨æˆ¶</p>
                <div class="text-left space-y-2 text-gray-800 doodle-box bg-gray-50 p-3 text-sm">
                    <p>1. é»æ“Šç€è¦½å™¨å³ä¸Šè§’çš„é¸å–®ï¼š<br><span class="inline-flex items-center justify-center doodle-item bg-white w-7 h-7 mt-1"><i class="ph-bold ph-dots-three-vertical text-gray-800 text-lg"></i></span></p>
                    <p>2. é¸æ“‡ <span class="font-bold doodle-item bg-white px-2 py-0.5 inline-block">åŠ åˆ°ä¸»ç•«é¢</span> æˆ– <span class="font-bold doodle-item bg-white px-2 py-0.5 inline-block">å®‰è£æ‡‰ç”¨ç¨‹å¼</span></p>
                </div>
            </div>

            <!-- é›»è…¦ç‰ˆèªªæ˜ -->
            <div id="desktop-instructions" class="hidden space-y-4 text-center">
                <p class="text-gray-800 font-bold text-lg bg-yellow-200 inline-block px-2 transform -rotate-1 border border-gray-800">ğŸ’» æ¡Œé¢ç‰ˆç€è¦½å™¨</p>
                <div class="text-left space-y-2 text-gray-800 doodle-box bg-gray-50 p-3 text-sm">
                    <p>1. é»æ“Šç¶²å€åˆ—å³å´çš„ä¸‹è¼‰åœ–ç¤ºï¼š<br><span class="inline-flex items-center justify-center doodle-item bg-white w-7 h-7 mt-1"><i class="ph-bold ph-download-simple text-gray-800 text-lg"></i></span> æˆ–ç€è¦½å™¨é¸å–®</p>
                    <p>2. é¸æ“‡ <span class="font-bold doodle-item bg-white px-2 py-0.5 inline-block">å®‰è£æ‡‰ç”¨ç¨‹å¼</span></p>
                </div>
            </div>
            
            <button onclick="closeInstallModal()" class="mt-6 w-full doodle-btn bg-pink-300 text-gray-800 font-bold py-2.5 hover:bg-pink-400 transition">æˆ‘çŸ¥é“äº†å–µï¼ğŸ¾</button>
        </div>
    </div>

    <!-- ä¿®æ”¹è¨˜äº‹ Modal -->
    <div id="edit-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
        <div class="doodle-box bg-white p-6 max-w-sm w-full relative">
            <h3 class="text-lg font-bold text-center text-gray-800 mb-4 flex justify-center items-center gap-2 bg-yellow-200 mx-auto w-max px-3 border border-gray-800 transform rotate-1">
                <i class="ph-bold ph-pencil-simple text-pink-500"></i> ä¿®æ”¹å¡—é´‰å–µ
            </h3>
            <textarea id="edit-task-input" rows="3" placeholder="è«‹è¼¸å…¥è¨˜äº‹å…§å®¹..." class="w-full doodle-item bg-gray-50 py-3 px-4 outline-none text-base mb-4 resize-none"></textarea>
            <input type="hidden" id="edit-task-id">
            <div class="flex gap-3">
                <button onclick="closeEditModal()" class="flex-1 doodle-btn bg-gray-200 text-gray-800 font-bold py-2 hover:bg-gray-300 transition">ç®—äº†</button>
                <button onclick="saveEditTask()" class="flex-1 doodle-btn bg-pink-400 text-white font-bold py-2 hover:bg-pink-500 transition">é‡ç•«å¥½æƒ¹</button>
            </div>
        </div>
    </div>

    <!-- è³‡æ–™ç®¡ç† Modal -->
    <div id="data-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
        <div class="doodle-box bg-white p-6 max-w-sm w-full relative">
            <button onclick="closeDataModal()" class="absolute top-3 right-3 text-gray-800 text-2xl hover:scale-110 transition"><i class="ph-bold ph-x"></i></button>
            <h3 class="text-xl font-bold text-center text-gray-800 mb-6 flex justify-center items-center gap-2">
                <i class="ph-bold ph-gear text-pink-500"></i> å·¥å…·ç®±
            </h3>
            
            <div class="space-y-4">
                <button onclick="exportData()" class="w-full doodle-btn bg-blue-200 text-gray-800 font-bold py-3 hover:bg-blue-300 transition flex items-center justify-center gap-2">
                    <i class="ph-bold ph-download-simple text-xl"></i> åŒ¯å‡ºå‚™ä»½ (æ‰“åŒ…å¸¶èµ°)
                </button>
                
                <label class="w-full doodle-btn bg-green-200 text-gray-800 font-bold py-3 hover:bg-green-300 transition flex items-center justify-center gap-2 cursor-pointer">
                    <i class="ph-bold ph-upload-simple text-xl"></i> åŒ¯å…¥å‚™ä»½ (è®€å–å›ä¾†)
                    <input type="file" id="import-file" class="hidden" accept=".json" onchange="importData(event)">
                </label>
            </div>
        </div>
    </div>
</div>

<script>
    // --- 1. è³‡æ–™èˆ‡ç‹€æ…‹ç®¡ç† ---
    let tasks = JSON.parse(localStorage.getItem('catTasks')) || [];
    let expandedState = { urgent: false, slow: false, completed: false };
    let expandedTextSet = new Set();

    // æ“´å……è‡³ 100 ç­†çš„è²“å’ªé¼“å‹µèªéŒ„è³‡æ–™åº«
    const catEncouragements = [
        "ä½ å¤ªæ£’äº†å–µï¼ğŸ¾", "åšçš„å¥½ï¼çå‹µä¸€å€‹ç½ç½å–µ~ğŸŸ", "å–µæ˜Ÿäººç‚ºä½ é©•å‚²ï¼âœ¨",
        "å¥´æ‰çœŸå‹¤å¥®å–µï¼ğŸ±", "å®Œæˆå•¦ï¼ä¾†æ‘¸æ‘¸è‚šå­å–µ~ğŸ’•", "å¤ªå²å®³äº†ï¼Œå–µå—šï¼ğŸ‰",
        "é€²åº¦æ»¿åˆ†ï¼å–µï¼ğŸ’¯", "è¶…ç´šæ£’çš„å–µï¼ğŸ˜»", "å®Œç¾ï¼è³ä½ è‚‰çƒå°ä¸€å€‹å–µğŸ¾",
        "åšå¾—å¥½ï¼çµ¦ä½ ä¸€å€‹å‘¼åš•åš•~ğŸ’¤", "å¥½æ£’ï¼è²“è‰æº–å‚™å¥½äº†å–µğŸŒ¿", "ç¥é€Ÿï¼ä½ æ˜¯æœ€æ£’çš„å–µï¼âš¡",
        "è²“è²“çµ¦è®šï¼ğŸ‘å–µ", "å®Œæˆä¸€ä»¶å¤§äº‹å•¦å–µï¼ğŸŒŸ", "å¤ªç¥å•¦ï¼è²“è²“å´‡æ‹œä½ å–µğŸ™€",
        "ç¹¼çºŒä¿æŒå–µï¼ğŸ˜½", "å¤ªæœ‰æ•ˆç‡äº†å–µï¼ğŸ”¥", "å¥½å²å®³ï¼è²“å’ªç‚ºä½ æ‹æ‰‹å–µğŸ‘",
        "åšå¾—çœŸæ£’ï¼Œè³ä½ ä¸€è²å–µ~ğŸµ", "å¥½è€¶ï¼ä¼‘æ¯ä¸€ä¸‹ä¾†é€—è²“å§å–µğŸ§¶", "å¤ªç‹‚äº†å–µï¼ä¸å¯æ€è­°ï¼ğŸ‡",
        "çœŸä¹–ï¼ä¸»å­è³ä½ ä¸€å€‹æŠ±æŠ±å–µğŸ’–", "æ•ˆç‡çªç ´å¤©éš›å–µï¼ğŸš€", "è²“è²“çœ‹å¥½ä½ å–”å–µï¼ğŸ‘€",
        "å¤ªæ„Ÿå‹•äº†ï¼Œè²“è²“è½æ·šå–µğŸ˜¿âœ¨", "åˆæå®šä¸€ä»¶å•¦ï¼Œå–µå“ˆï¼ğŸ˜º", "å¥´æ‰åšå¾—å¥½ï¼Œä»Šæ™šä¸æ—äº‚å–µğŸ¾",
        "æœ¬å–µå®£ä½ˆä½ ä»Šå¤©æœ€æ£’ï¼ğŸ‘‘", "çµ¦ä½ ä¸€å€‹è²“å¼æ“ŠæŒå–µï¼ğŸ™Œ", "ç¥ä¹å…¶æŠ€çš„æ•ˆç‡å–µï¼âœ¨",
        "è²“è²“ç‚ºä½ æ­¡å‘¼å–µï¼ğŸŠ", "ä½ å°±æ˜¯æ•ˆç‡ä¹‹ç¥å–µï¼âš¡", "å¤ªè®šäº†ï¼è²“è²“æ‰“æ»¾æ…¶ç¥å–µğŸ”„",
        "å¥½è€¶ï¼åƒå€‹è‚‰æ³¥æ…¶ç¥ä¸€ä¸‹å–µğŸ—", "ç„¡æ•µäº†å–µï¼ğŸ˜", "åˆéäº†ä¸€é—œï¼Œå–µå–µå–µï¼ğŸ®",
        "çµ¦ä½ ä¸€å€‹å¤§å¤§çš„è²“å’ªå»å–µğŸ’‹", "åšå®Œå•¦ï¼å¿«ä¾†é™ªæœ¬å–µç©ï¼ğŸ§¸", "ä¸æ„§æ˜¯æˆ‘çš„å¥´æ‰å–µï¼ğŸ˜¼",
        "å–µå‘¼ï¼é€™é€Ÿåº¦é€£è²“éƒ½è¿½ä¸ä¸ŠğŸƒ", "è®šå•¦ï¼è²“è²“ç˜‹ç‹‚é»é ­å–µé»é»é»", "é †åˆ©å®Œæˆï¼è²“è²“æ’’èŠ±å–µğŸŒ¸",
        "ä½ ä»Šå¤©é–ƒé–ƒç™¼å…‰å–µï¼âœ¨", "å¤ªå¸¥äº†å–µï¼ğŸ˜", "è²“è²“çµ¦ä½ æ‰“ 100 åˆ†å–µï¼ğŸ’¯",
        "æ²’ä»€éº¼èƒ½é›£å€’ä½ å–µï¼ğŸ’ª", "é€™æ•ˆç‡æœ¬å–µå¾ˆæ»¿æ„å–µï¼ğŸˆ", "æ¼‚äº®çš„ä¸€æ“Šå–µï¼ğŸ¯",
        "åˆè§£æ±ºä¸€å€‹éº»ç…©å–µï¼ğŸ§¹", "ä½ æ¯”é€—è²“æ£’é‚„å¸å¼•äººå–µï¼âœ¨", "å¥½æ£’æ£’ï¼Œè²“è²“è¹­è¹­ä½ å–µ~ğŸ¥°",
        "ç¹¼çºŒè¡åˆºå–µï¼ğŸƒâ€â™‚ï¸ğŸ’¨", "è²“è²“ç‚ºä½ æ–å°¾å·´å–µï¼ğŸˆ", "åšå¾—å¥½ï¼Œä»Šæ™šåŠ èœå–µï¼ğŸ±",
        "å¤ªæ£’äº†ï¼æœ¬å–µå…è¨±ä½ å¸ä¸€å£å–µğŸ’¨", "å„ªç§€ï¼è²“è²“ç‚ºä½ å¯«è©©å–µğŸ“œ", "ç„¡å¯æŒ‘å‰”å–µï¼ğŸ‘Œ",
        "ä½ è®“æœ¬å–µåˆ®ç›®ç›¸çœ‹å–µï¼ğŸ˜²", "é€™å°±å°äº†å–µï¼ğŸ‘", "åšå¾—çœŸé †æ‰‹å–µï¼ğŸ¾",
        "è²“è²“è¦ºå¾—ä½ å¾ˆå¯ä»¥å–µï¼ğŸ˜", "è¶…ç´šå¥´æ‰èª•ç”Ÿå–µï¼ğŸ¦¸", "å®Œæˆåº¦ 100% å–µï¼ğŸ”‹",
        "åšå¾—å¥½ï¼è²“è²“è³ä½ ä¸€å€‹è¸è¸å–µğŸ¾", "å¥½å²å®³ï¼è²“è²“ç‚ºä½ å”±æ­Œå–µğŸ¤", "ä½ ä»Šå¤©è¶…å¯æ„›çš„å–µï¼ğŸ’–",
        "å¤ªæ£’å•¦ï¼è²“è²“ç‚ºä½ è·³èˆå–µğŸ’ƒ", "ç„¡äººèƒ½æ•µå–µï¼ğŸ†", "åˆå®Œæˆä¸€é …å£¯èˆ‰å–µï¼ğŸ§—",
        "è²“è²“è¦ºå¾—ä½ è¶…é…·å–µï¼ğŸ•¶ï¸", "è®šç¾ä½ å–µï¼ğŸ™Œ", "åšå¾—å¥½ï¼Œè²“è²“çµ¦ä½ å‘¼åš•å‘¼åš•å–µã€°ï¸",
        "å¤ªæ£’äº†ï¼Œæœ¬å–µæ±ºå®šä»Šæ™šè·Ÿä½ ç¡å–µğŸ›ï¸", "é€™æ•ˆç‡ç°¡ç›´æ˜¯é­”æ³•å–µï¼ğŸ§™", "å¥½è€¶ï¼è²“è²“çµ¦ä½ æŒ‰å€‹è®šå–µğŸ‘",
        "ä½ å°±æ˜¯æœ€äº®çš„é‚£é¡†æ˜Ÿå–µï¼â­", "è²“è²“å°ä½ è¡¨ç¤ºæ•¬æ„å–µï¼ğŸ«¡", "å®Œæˆå¾—ä¹¾æ·¨ä¿è½å–µï¼ğŸ”ª",
        "å¤ªæ£’äº†ï¼è²“è²“çµ¦ä½ ä¸€å€‹é£›å»å–µğŸ˜˜", "ä½ è¶…æœƒçš„å–µï¼ğŸ¤“", "é€™é€Ÿåº¦æœ¬å–µçµ¦æ»¿åˆ†å–µï¼ğŸ’¯",
        "å¥½æ£’ï¼æœ¬å–µçš„å°¾å·´ç‚ºä½ ç¿¹é«˜é«˜å–µğŸˆ", "å¤ªç¥äº†ï¼è²“è²“è¦æ‹œä½ ç‚ºå¸«å–µğŸ™‡", "å®Œç¾é”é™£å–µï¼ğŸˆ",
        "é€™è¡¨ç¾å¤ªè€€çœ¼äº†å–µï¼ğŸŒŸ", "åšå¾—å¥½ï¼è²“è²“è«‹ä½ å–æ°´å–µğŸ’§", "ä½ å°±æ˜¯å¥‡è¹Ÿå–µï¼ğŸŒˆ",
        "å¤ªæ£’äº†ï¼è²“è²“ç‚ºä½ æ”¾ç…™ç«å–µğŸ†", "å¥½å²å®³ï¼è²“è²“å¹«ä½ æ¥èƒŒå–µğŸ’†", "ä½ ä»Šå¤©æˆ°é¬¥åŠ›ç ´è¡¨å–µï¼ğŸ’¥",
        "å¤ªå¼·äº†ï¼è²“è²“ç‚ºä½ å–é‡‡å–µğŸ—£ï¸", "å¥½è€¶ï¼è²“è²“ç‚ºä½ é–‹ç½ç½æ…¶ç¥å–µğŸ¥«", "é€™é€²åº¦æœ¬å–µå¾ˆæ”¾å¿ƒå–µï¼ğŸ˜Œ",
        "ä½ å°±æ˜¯æ•ˆç‡çš„ä»£åè©å–µï¼ğŸ“–", "å¤ªæ£’äº†ï¼è²“è²“ç‚ºä½ é ’ç™¼çç‹€å–µğŸ“œ", "å¥½å²å®³ï¼è²“è²“ç‚ºä½ æˆ´ä¸Šçš‡å† å–µğŸ‘‘",
        "ä½ ä»Šå¤©è¶…æ£’çš„ï¼Œå¿«å»ä¼‘æ¯å–µï¼ğŸ›‹ï¸", "å¤ªçŒ›äº†ï¼è²“è²“è¢«ä½ çš„æ•ˆç‡åš‡åˆ°äº†å–µğŸ™€", "å¥½è€¶ï¼æœ¬å–µç‚ºä½ æ„Ÿåˆ°é©•å‚²å–µğŸ¦",
        "ä½ åšåˆ°äº†å–µï¼ğŸ‰", "å¤ªæ£’äº†ï¼é€™å°±æ˜¯å¥´æ‰çš„åŠ›é‡å–µï¼ğŸ’ª", "é€™æ³¢æ“ä½œ 666 å–µï¼ğŸ•¹ï¸"
    ];

    // æ–°å¢ï¼š100 ç­†å–æ¶ˆå‹¾é¸/é‡æ–°æŒ‘æˆ°çš„è²“å’ªé¼“å‹µèªéŒ„è³‡æ–™åº«
    const catUncheckEncouragements = [
        "æ²’é—œä¿‚å–µï¼Œæˆ‘å€‘é‡æ–°å†ä¾†ï¼ğŸ¾", "æœ¬å–µé™ªä½ ä¸€èµ·é‡æ–°æŒ‘æˆ°å–µï¼ğŸ’ª", "ä¼‘æ¯ä¸€ä¸‹å†å‡ºç™¼å–µï¼â˜•", "ä¸æ€¥ä¸æ€¥ï¼Œæ…¢æ…¢ä¾†å–µ~ğŸ¢", "ç™¼ç¾éŒ¯èª¤æ˜¯å¥½äº‹å–µï¼ğŸ”", 
        "è²“è²“ç›¸ä¿¡ä½ å¯ä»¥çš„å–µï¼âœ¨", "å†è©¦ä¸€æ¬¡ï¼Œé€™æ¬¡ä¸€å®šæ›´å¥½å–µï¼ğŸŒŸ", "å¤±æ•—æ˜¯æˆåŠŸä¹‹æ¯å–µï¼ğŸ‘©â€ğŸ‘§", "æ“¦ä¹¾çœ¼æ·šï¼Œæ‘¸æ‘¸è²“è²“ç¹¼çºŒå–µï¼ğŸ˜¿", "å°±ç®—é€€å¾Œä¸€æ­¥ï¼Œæœ¬å–µä¹Ÿæœƒæ¥ä½ä½ å–µï¼ğŸ‘",
        "æ²’åšå®Œä¹Ÿæ²’é—œä¿‚ï¼Œè²“è²“æŠ±æŠ±å–µï¼ğŸ«‚", "å¤§ä¸äº†é‡é ­ä¾†éå–µï¼ğŸ”„", "çµ¦è‡ªå·±å¤šä¸€é»æ™‚é–“å–µ~â³", "è¿½æ±‚å®Œç¾å¾ˆå¥½ï¼Œä½†æ…¢æ…¢ä¾†ä¹Ÿè¡Œå–µï¼ğŸ‘Œ", "é‡æ–°é–‹å§‹ä¹Ÿæ˜¯ä¸€ç¨®å‹‡æ°£å–µï¼ğŸ¦",
        "è²“è²“çš„å‘¼åš•åš•çµ¦ä½ åŠ›é‡å–µï¼ã€°ï¸", "æ·±å‘¼å¸ï¼Œçœ‹è‘—æœ¬å–µå†è©¦ä¸€æ¬¡å–µï¼ğŸ˜®â€ğŸ’¨", "æˆ‘å€‘ä¸€èµ·æŠŠå®ƒè®Šå¾—æ›´å¥½å–µï¼ğŸ”¨", "é€™é»å°æŒ«æŠ˜æ‰“ä¸å€’ä½ çš„å–µï¼ğŸ¥Š", "è²“è²“é™ªä½ é‡é ­æ‰“æ€ªå–µï¼ğŸ‘¾",
        "æ²’é—œä¿‚ï¼Œæ™šé»åšä¹Ÿè¡Œå–µï¼ğŸŒ™", "å…ˆå¸å£è²“å†ç¹¼çºŒå–µï¼ğŸ’¨", "ä»Šå¤©å¾ˆç´¯çš„è©±ï¼Œæ˜å¤©å†èªªå–µï¼ğŸ›Œ", "ä¸è¦çµ¦è‡ªå·±å¤ªå¤§å£“åŠ›å–µï¼ğŸˆ", "æœ¬å–µéš¨æ™‚ç‚ºä½ åŠ æ²¹æ‰“æ°£å–µï¼ğŸ“£",
        "é‡æ–°ä¾†éï¼Œæˆ–è¨±æœƒæœ‰æ–°ç™¼ç¾å–µï¼ğŸ’¡", "æ²’äº‹æ²’äº‹ï¼Œè²“è²“è¹­è¹­ä½ å–µ~ğŸ¥°", "å°±ç®—å–æ¶ˆäº†ï¼Œæœ¬å–µé‚„æ˜¯æœ€æ„›ä½ å–µï¼â¤ï¸", "æ…¢æ…¢ä¾†æ¯”è¼ƒå¿«å–µï¼ğŸŒ", "å†æ¥å†å²å–µï¼ğŸ¾",
        "ä¸å®Œç¾ä¹Ÿæ²’é—œä¿‚å–µï¼ğŸ¨", "è²“è²“é™ªä½ ä¸€èµ·ä¿®å¾©å®ƒå–µï¼ğŸ”§", "å¥½é£¯ä¸æ€•æ™šå–µï¼ğŸš", "æˆ‘å€‘å†ä¸€èµ·åŠªåŠ›ä¸€æ¬¡å–µï¼ğŸ¤", "è·Œå€’äº†å°±é †ä¾¿åœ¨åœ°ä¸Šèººä¸€ä¸‹å–µï¼ğŸ›Œ",
        "è²“è²“å€Ÿä½ è‚‰çƒçµ¦ä½ åŠ›é‡å–µï¼ğŸ¾", "ä¸è¦æ°£é¤’å–µï¼ğŸ’ª", "æœ¬å–µçš„å°¾å·´ç‚ºä½ åŠ æ²¹å–µï¼ğŸˆ", "å†ä¾†ä¸€æ¬¡ï¼Œé€™æ¬¡æ›å€‹æ–¹æ³•å–µï¼ğŸ”„", "æ²’é—œä¿‚ï¼Œè²“è²“æ‡‚ä½ çš„è¾›è‹¦å–µï¼ğŸ¥º",
        "å…ˆç¡å€‹åˆè¦ºå†æŒ‘æˆ°å–µï¼ğŸ˜´", "æˆ‘å€‘ä¸è¶•æ™‚é–“å–µ~ğŸ•°ï¸", "å°±ç®—æ²’åšå®Œï¼Œä½ ä¹Ÿæ˜¯æœ€æ£’çš„å¥´æ‰å–µï¼ğŸ‘‘", "è²“è²“æœƒä¸€ç›´é™ªåœ¨ä½ èº«é‚Šå–µï¼ğŸ‘«", "é‡åšä¸€æ¬¡ï¼Œè¨˜æ†¶æ›´æ·±åˆ»å–µï¼ğŸ§ ",
        "æ²’é—œä¿‚ï¼Œè²“è²“å¹«ä½ æŠŠç…©æƒ±åƒæ‰å–µï¼ğŸ˜‹", "å†æŒ‘æˆ°ä¸€æ¬¡ï¼Œä½ æœƒæ›´å¼·å¤§å–µï¼ğŸ‹ï¸", "æ·±å‘¼å¸ï¼Œåæ°£ï¼Œå†ä¾†ä¸€æ¬¡å–µï¼ğŸŒ¬ï¸", "è²“è²“çš„é­”æ³•ç‚ºä½ åŠ æŒå–µï¼ğŸª„", "å°±ç®—å¤±æ•—ï¼Œä¹Ÿè¦åƒæœ¬å–µä¸€æ¨£å„ªé›…å–µï¼âœ¨",
        "æ²’é—œä¿‚ï¼Œæˆ‘å€‘æœ‰çš„æ˜¯æ™‚é–“å–µï¼ğŸ—“ï¸", "å…ˆåƒå€‹ç½ç½è£œå……é«”åŠ›å–µï¼ğŸŸ", "ä¸è¦ç°å¿ƒå–µï¼ğŸ˜¿", "è²“è²“ç›¸ä¿¡ä½ çš„æ½›åŠ›å–µï¼ğŸš€", "å†è©¦ä¸€æ¬¡ï¼Œä¹Ÿè¨±å°±æˆåŠŸäº†å–µï¼ğŸ¯",
        "æ²’äº‹ï¼Œæœ¬å–µé™ªä½ ä¸€èµ·æ‰¾å•é¡Œå–µï¼ğŸ•µï¸", "æ…¢æ…¢ä¾†ï¼Œæœ¬å–µä¸å‚¬ä½ å–µï¼ğŸ¢", "å°±ç®—é‡ä¾†ï¼Œæœ¬å–µçš„æ„›ä¹Ÿä¸æœƒæ¸›å°‘å–µï¼ğŸ’–", "æˆ‘å€‘ä¸€èµ·æŠŠé€™å¡Šçµ†è…³çŸ³è¸¢é–‹å–µï¼ğŸª¨", "ä¸è¦æ€•ï¼Œè²“è²“åœ¨å¾Œé¢ç½©ä½ å–µï¼ğŸ›¡ï¸",
        "æ²’é—œä¿‚ï¼Œæ˜å¤©åˆæ˜¯æ–°çš„ä¸€å¤©å–µï¼ğŸŒ…", "å…ˆæ“¼å€‹è²“æ”¾é¬†ä¸€ä¸‹å–µï¼ğŸ’†", "æˆ‘å€‘ä¸€èµ·æŠŠå®ƒåšå¾—æ›´å®Œç¾å–µï¼ğŸ’", "å¤±æ•—åªæ˜¯æš«æ™‚çš„å–µï¼â³", "è²“è²“ç‚ºä½ æ–æ——å¶å–Šå–µï¼ğŸš©",
        "æ²’äº‹æ²’äº‹ï¼Œå¤§ä¸äº†å†åšä¸€æ¬¡å–µï¼ğŸ”„", "æ…¢æ…¢åšï¼Œæœ¬å–µæœƒåœ¨æ—é‚Šå®ˆè­·ä½ å–µï¼ğŸ‘¼", "å°±ç®—å–æ¶ˆäº†ï¼Œæœ¬å–µé‚„æ˜¯ç‚ºä½ é©•å‚²å–µï¼ğŸ¦š", "æˆ‘å€‘å…ˆå»ç©ä¸€ä¸‹å†å›ä¾†åšå–µï¼ğŸ§¸", "ä¸è¦çµ¦è‡ªå·±å¤ªå¤šè² æ“”å–µï¼ğŸ’",
        "è²“è²“çš„å‘¼åš•è²æ˜¯æœ€å¥½çš„å®‰æ…°å–µï¼ã€°ï¸", "å†æŒ‘æˆ°ä¸€æ¬¡ï¼Œè²“è²“çœ‹å¥½ä½ å–µï¼ğŸ‘€", "æ²’é—œä¿‚ï¼Œæœ¬å–µå…è¨±ä½ è€å»¢ä¸€ä¸‹å–µï¼ğŸ›‹ï¸", "æˆ‘å€‘å…ˆåƒé£½å†èªªå–µï¼ğŸ±", "å°±ç®—é‡ä¾†ï¼Œä½ ä¹Ÿå·²ç¶“é€²æ­¥äº†å–µï¼ğŸ“ˆ",
        "è²“è²“é™ªä½ ä¸€èµ·é¢å°å–µï¼ğŸ¦", "ä¸è¦å“­ï¼Œè²“è²“å¹«ä½ èˆ”çœ¼æ·šå–µï¼ğŸ‘…", "å†è©¦ä¸€æ¬¡ï¼Œé€™æ¬¡ä¸€å®šæ²’å•é¡Œå–µï¼ğŸ‘Œ", "æ²’é—œä¿‚ï¼Œæœ¬å–µä¸€ç›´éƒ½åœ¨å–µï¼ğŸ ", "æ…¢æ…¢ä¾†ï¼Œæœ¬å–µæœ‰è€å¿ƒç­‰ä½ å–µï¼â³",
        "å°±ç®—æ²’å®Œæˆï¼Œæœ¬å–µé‚„æ˜¯è¦ºå¾—ä½ å¾ˆæ£’å–µï¼ğŸŒŸ", "æˆ‘å€‘ä¸€èµ·æŠŠå®ƒè§£æ±ºæ‰å–µï¼ğŸ’¥", "ä¸è¦æ”¾æ£„å–µï¼ğŸ’ª", "è²“è²“çš„è‚‰çƒçµ¦ä½ æ‹æ‹å–µï¼ğŸ¾", "å†ä¾†ä¸€æ¬¡ï¼Œé€™æ¬¡ä¸€å®šè¡Œå–µï¼ğŸ’¯",
        "æ²’äº‹ï¼Œæœ¬å–µé™ªä½ ä¸€èµ·é‡å¯«å–µï¼âœï¸", "å…ˆä¼‘æ¯ä¸€ä¸‹ï¼Œå–å£æ°´å–µï¼ğŸ’§", "æˆ‘å€‘ä¸€èµ·æŠŠå›°é›£æ‰“æ•—å–µï¼ğŸ¥Š", "å°±ç®—å¤±æ•—ï¼Œæœ¬å–µä¹Ÿæœƒé€—ä½ é–‹å¿ƒå–µï¼ğŸ¤¡", "è²“è²“ç›¸ä¿¡ä½ ä¸€å®šå¯ä»¥å…‹æœçš„å–µï¼ğŸ§—",
        "å†è©¦ä¸€æ¬¡ï¼Œé€™æ¬¡æœƒæ›´é †åˆ©å–µï¼ğŸ›¹", "æ²’é—œä¿‚ï¼Œæœ¬å–µä¸å«Œæ£„ä½ å–µï¼ğŸ˜¹", "æ…¢æ…¢ä¾†ï¼Œæœ¬å–µé™ªä½ ä¸€èµ·ç†¬å¤œå–µï¼ğŸ¦‰", "å°±ç®—é‡ä¾†ï¼Œæœ¬å–µçš„ç½ç½é‚„æ˜¯è¦çµ¦å–µï¼ğŸ¥«", "æˆ‘å€‘å…ˆå»çœ‹å€‹å½±ç‰‡æ”¾é¬†ä¸€ä¸‹å–µï¼ğŸ“º",
        "ä¸è¦æ°£é¤’ï¼Œè²“è²“ç‚ºä½ åŠ æ²¹æ‰“æ°£å–µï¼ğŸ“£", "è²“è²“çš„å‘¼åš•é­”æ³•ç‚ºä½ ç™‚ç™’å–µï¼ğŸª„", "å†æŒ‘æˆ°ä¸€æ¬¡ï¼Œæœ¬å–µç­‰ä½ çš„å¥½æ¶ˆæ¯å–µï¼ğŸ“°", "æ²’é—œä¿‚ï¼Œæœ¬å–µé™ªä½ ä¸€èµ·æ‰¾å›ç‹€æ…‹å–µï¼ğŸ”‹", "ä¸ç®¡æ€æ¨£ï¼Œæœ¬å–µæ°¸é æ”¯æŒä½ å–µï¼ğŸ¥°"
    ];

    // --- 2. æ ¸å¿ƒåˆå§‹åŒ– ---
    document.addEventListener('DOMContentLoaded', () => {
        renderTasks();
        setupPWA();
        checkInstallState();
    });

    function saveTasks() {
        localStorage.setItem('catTasks', JSON.stringify(tasks));
    }

    // å°‡åƒæ•¸ msg å‚³å…¥ä»¥å‹•æ…‹é¡¯ç¤ºæ–‡å­—
    function showCatToast(msg) {
        const toast = document.getElementById('cat-toast');
        toast.innerHTML = `<i class="ph-fill ph-cat text-2xl text-pink-500"></i> <span class="text-gray-800">${msg}</span>`;
        
        toast.classList.remove('opacity-0', 'scale-95', 'pointer-events-none');
        toast.classList.add('opacity-100', 'scale-100', '-translate-y-2');
        
        setTimeout(() => {
            toast.classList.remove('opacity-100', 'scale-100', '-translate-y-2');
            toast.classList.add('opacity-0', 'scale-95', 'pointer-events-none');
        }, 2500);
    }

    function checkInstallState() {
        const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone || document.referrer.includes('android-app://');
        if (isStandalone) document.getElementById('install-btn').style.display = 'none';
    }

    window.addEventListener('appinstalled', () => {
        document.getElementById('install-btn').style.display = 'none';
    });

    // --- 3. è¨˜äº‹æ“ä½œ ---
    function addTask() {
        const input = document.getElementById('task-input');
        const text = input.value.trim();
        if (!text) return alert('è«‹è¼¸å…¥è¨˜äº‹å…§å®¹å–µï¼ğŸ¾');

        const tag = document.querySelector('input[name="task-tag"]:checked').value;
        const newTask = {
            id: Date.now().toString(),
            text: text,
            tag: tag,
            isCompleted: false,
            createdAt: Date.now()
        };

        tasks.push(newTask);
        saveTasks();
        input.value = ''; 
        renderTasks();
    }

    function deleteTask(id) {
        tasks = tasks.filter(t => String(t.id) !== String(id));
        saveTasks();
        renderTasks();
    }

    function editTask(id) {
        const task = tasks.find(t => String(t.id) === String(id));
        if (!task) return;
        document.getElementById('edit-task-id').value = task.id;
        document.getElementById('edit-task-input').value = task.text;
        document.getElementById('edit-modal').classList.remove('hidden');
    }

    function closeEditModal() { document.getElementById('edit-modal').classList.add('hidden'); }

    function saveEditTask() {
        const id = document.getElementById('edit-task-id').value;
        const newText = document.getElementById('edit-task-input').value.trim();
        if (newText) {
            const task = tasks.find(t => String(t.id) === String(id));
            if (task) {
                task.text = newText;
                saveTasks();
                renderTasks();
            }
        }
        closeEditModal();
    }

    // æ›´æ–° toggleComplete ä»¥æ”¯æ´å…©ç¨®ä¸åŒç‹€æ…‹çš„èªéŒ„éš¨æ©Ÿæ’­æ”¾
    function toggleComplete(id) {
        const task = tasks.find(t => String(t.id) === String(id));
        if (task) {
            task.isCompleted = !task.isCompleted;
            
            // æ ¹æ“šæ˜¯å¦å®Œæˆä¾†æŠ½å–å°æ‡‰çš„èªéŒ„
            if (task.isCompleted) {
                const msg = catEncouragements[Math.floor(Math.random() * catEncouragements.length)];
                showCatToast(msg);
            } else {
                const msg = catUncheckEncouragements[Math.floor(Math.random() * catUncheckEncouragements.length)];
                showCatToast(msg);
            }
            
            saveTasks();
            renderTasks();
        }
    }

    function changeTag(id, newTag) {
        const task = tasks.find(t => String(t.id) === String(id));
        if (task) {
            task.tag = newTag;
            saveTasks();
            renderTasks();
        }
    }

    function toggleExpand(category) {
        expandedState[category] = !expandedState[category];
        renderTasks();
    }

    function toggleTextExpand(id) {
        if (expandedTextSet.has(id)) expandedTextSet.delete(id);
        else expandedTextSet.add(id);
        renderTasks();
    }

    function renderTasks() {
        document.getElementById('list-urgent').innerHTML = '';
        document.getElementById('list-slow').innerHTML = '';
        document.getElementById('list-completed').innerHTML = '';

        const sortedTasks = [...tasks].sort((a, b) => b.createdAt - a.createdAt);

        const grouped = {
            urgent: sortedTasks.filter(t => !t.isCompleted && t.tag === 'urgent'),
            slow: sortedTasks.filter(t => !t.isCompleted && t.tag === 'slow'),
            completed: sortedTasks.filter(t => t.isCompleted)
        };

        const createLi = (task) => {
            const li = document.createElement('li');
            // å¥—ç”¨å¡—é´‰é¢¨æ ¼ class: doodle-item
            li.className = `doodle-item py-2 px-3 flex items-start gap-2.5 transition-all ${task.isCompleted ? 'bg-gray-50 opacity-80' : 'bg-white'}`;
            
            let tagBg = task.tag === 'urgent' ? 'bg-pink-200 text-gray-800' : 'bg-blue-200 text-gray-800';
            const isTextExpanded = expandedTextSet.has(task.id);
            const clampClass = isTextExpanded ? '' : 'line-clamp-2';

            li.innerHTML = `
                <!-- å·¦æ¬„ï¼šæ ¸å–æ–¹å¡Šèˆ‡æ¨™ç±¤ -->
                <div class="flex flex-col items-center gap-1.5 flex-shrink-0 pt-0.5 w-[3.5rem]">
                    <input type="checkbox" onchange="toggleComplete('${task.id}')" ${task.isCompleted ? 'checked' : ''} class="w-5 h-5 m-0">
                    <div class="relative w-full">
                        <select onchange="changeTag('${task.id}', this.value)" class="appearance-none w-full text-center cursor-pointer text-[10px] font-bold py-0.5 border-2 border-gray-800 focus:outline-none focus:bg-yellow-200 ${tagBg} doodle-btn" style="box-shadow: 1px 1px 0px #1f2937; border-radius: 4px;">
                            <option value="urgent" ${task.tag === 'urgent' ? 'selected' : ''}>ğŸ’–ç·Šæ€¥</option>
                            <option value="slow" ${task.tag === 'slow' ? 'selected' : ''}>ğŸ’™æ…¢æ…¢</option>
                        </select>
                        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center pr-0.5">
                            <i class="ph-bold ph-caret-down text-[8px] text-gray-800"></i>
                        </div>
                    </div>
                </div>

                <!-- ä¸­æ¬„ï¼šç­†è¨˜å…§å®¹ -->
                <div class="flex-1 min-w-0 flex flex-col justify-start">
                    <div id="text-${task.id}" class="font-bold break-words text-[14px] sm:text-base leading-snug ${task.isCompleted ? 'text-gray-400 line-through' : 'text-gray-800'} ${clampClass}">
                        ${task.text}
                    </div>
                    <button id="more-btn-${task.id}" onclick="toggleTextExpand('${task.id}')" class="hidden text-left text-[11px] font-extrabold text-pink-500 mt-1 hover:text-pink-600 w-max tracking-wide bg-yellow-100 px-1 border border-gray-800 transform -rotate-1">
                        ${isTextExpanded ? 'æ”¶èµ· ğŸ”¼' : 'é¡¯ç¤ºæ›´å¤š ğŸ”½'}
                    </button>
                </div>
                
                <!-- å³æ¬„ï¼šæŒ‰éˆ•å€ -->
                <div class="flex flex-col items-center gap-1 flex-shrink-0 pt-0">
                    <button onclick="editTask('${task.id}')" class="text-gray-600 hover:text-blue-500 transition p-0.5 hover:scale-110" title="ä¿®æ”¹"><i class="ph-bold ph-pencil-simple text-base sm:text-lg"></i></button>
                    <button onclick="deleteTask('${task.id}')" class="text-gray-600 hover:text-red-500 transition p-0.5 hover:scale-110" title="åˆªé™¤"><i class="ph-bold ph-trash text-base sm:text-lg"></i></button>
                </div>
            `;
            return li;
        };

        ['urgent', 'slow', 'completed'].forEach(category => {
            const listEl = document.getElementById(`list-${category}`);
            const items = grouped[category];
            
            if (items.length === 0) {
                listEl.innerHTML = `<li class="text-center text-[14px] py-2 text-gray-500 font-bold border-2 border-dashed border-gray-400 rounded-lg bg-gray-50/50 transform rotate-1">æ²’æœ‰ä»»å‹™å–µ ğŸ¾</li>`;
                return;
            }

            const limit = 5;
            const isExpanded = expandedState[category];
            const displayItems = isExpanded ? items : items.slice(0, limit);

            displayItems.forEach(task => listEl.appendChild(createLi(task)));

            if (items.length > limit) {
                const btnLi = document.createElement('li');
                btnLi.className = 'text-center pt-2 pb-1';
                const remaining = items.length - limit;
                btnLi.innerHTML = `
                    <button onclick="toggleExpand('${category}')" class="doodle-btn text-[12px] font-bold text-gray-800 bg-white hover:bg-yellow-200 transition flex justify-center items-center gap-1 mx-auto px-4 py-1.5">
                        ${isExpanded ? '<i class="ph-bold ph-caret-up"></i> æ”¶èµ·æ¸…å–®' : `<i class="ph-bold ph-caret-down"></i> é‚„æœ‰ ${remaining} ç­†æ²’ç•«å®Œ`}
                    </button>
                `;
                listEl.appendChild(btnLi);
            }
        });

        requestAnimationFrame(() => {
            tasks.forEach(task => {
                const textEl = document.getElementById(`text-${task.id}`);
                const moreBtn = document.getElementById(`more-btn-${task.id}`);
                if (textEl && moreBtn) {
                    const isOverflowing = textEl.scrollHeight > textEl.clientHeight + 2;
                    const isExpanded = expandedTextSet.has(task.id);
                    if (isOverflowing || isExpanded) {
                        moreBtn.classList.remove('hidden');
                    }
                }
            });
        });
    }

    // --- 4. èªéŸ³è¼¸å…¥ ---
    function startVoiceRecognition() {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognition) {
            alert('æŠ±æ­‰å–µï¼æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³è¾¨è­˜ ğŸ˜¿');
            return;
        }

        const recognition = new SpeechRecognition();
        recognition.lang = 'zh-TW';
        recognition.interimResults = true; 
        recognition.maxAlternatives = 1;

        const micBtn = document.getElementById('mic-btn');
        const input = document.getElementById('task-input');
        
        micBtn.innerHTML = '<i class="ph-bold ph-ear"></i>';
        micBtn.classList.add('animate-bounce', 'text-pink-600');

        let originalText = input.value ? input.value + ' ' : '';

        recognition.start();

        recognition.onresult = (event) => {
            let interimTranscript = '';
            let finalTranscript = '';
            for (let i = event.resultIndex; i < event.results.length; ++i) {
                if (event.results[i].isFinal) finalTranscript += event.results[i][0].transcript;
                else interimTranscript += event.results[i][0].transcript;
            }
            input.value = (originalText + finalTranscript + interimTranscript).trim();
            if (finalTranscript) originalText = (originalText + finalTranscript + ' ');
        };

        recognition.onerror = (event) => console.error('èªéŸ³è¾¨è­˜éŒ¯èª¤:', event.error);
        recognition.onend = () => {
            micBtn.innerHTML = '<i class="ph-fill ph-microphone-stage"></i>';
            micBtn.classList.remove('animate-bounce', 'text-pink-600');
        };
    }

    // --- 5. Modal æ§åˆ¶èˆ‡è³‡æ–™ç®¡ç† ---
    function openDataModal() { document.getElementById('data-modal').classList.remove('hidden'); }
    function closeDataModal() { document.getElementById('data-modal').classList.add('hidden'); }

    function exportData() {
        if (tasks.length === 0) return alert('ç›®å‰æ²’æœ‰è¨˜äº‹å¯ä»¥åŒ¯å‡ºå–µï¼');
        const dataStr = JSON.stringify(tasks, null, 2);
        const blob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `cat-tasks-backup-${new Date().toISOString().slice(0,10)}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        closeDataModal();
    }

    function importData(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const importedTasks = JSON.parse(e.target.result);
                if (Array.isArray(importedTasks)) {
                    const existingIds = new Set(tasks.map(t => String(t.id)));
                    importedTasks.forEach(t => {
                        if (!existingIds.has(String(t.id))) {
                            if (t.isCompleted === undefined) t.isCompleted = false;
                            if (t.tag === 'normal') t.tag = 'slow';
                            tasks.push(t);
                        }
                    });
                    saveTasks();
                    renderTasks();
                    alert('åŒ¯å…¥æˆåŠŸå–µï¼ğŸ¾');
                    closeDataModal();
                } else { throw new Error('æ ¼å¼éŒ¯èª¤'); }
            } catch (err) { alert('åŒ¯å…¥å¤±æ•—ï¼Œè«‹ç¢ºèªæª”æ¡ˆæ ¼å¼å–µï¼ğŸ˜¿'); }
        };
        reader.readAsText(file);
        event.target.value = ''; 
    }

    // --- 6. PWA å®‰è£é‚è¼¯ ---
    function setupPWA() {
        const manifest = {
            "name": "è²“å’ªè¨˜äº‹æœ¬",
            "short_name": "è²“å’ªè¨˜äº‹",
            "start_url": "./",
            "display": "standalone",
            "background_color": "#fdfaf6",
            "theme_color": "#fef08a",
            "icons": [{
                "src": "data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ±</text></svg>",
                "sizes": "192x192",
                "type": "image/svg+xml"
            }]
        };
        const manifestString = JSON.stringify(manifest);
        document.getElementById('manifest-link').href = 'data:application/json;charset=utf-8,' + encodeURIComponent(manifestString);

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js').catch(() => {});
        }
    }

    function openInstallModal() {
        const modal = document.getElementById('install-modal');
        const iosInst = document.getElementById('ios-instructions');
        const andInst = document.getElementById('android-instructions');
        const desktopInst = document.getElementById('desktop-instructions');
        
        const ua = navigator.userAgent.toLowerCase();
        const isIOS = /ipad|iphone|ipod/.test(ua) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
        const isAndroid = /android/.test(ua);
        
        iosInst.classList.add('hidden');
        andInst.classList.add('hidden');
        desktopInst.classList.add('hidden');

        if (isIOS) iosInst.classList.remove('hidden');
        else if (isAndroid) andInst.classList.remove('hidden');
        else desktopInst.classList.remove('hidden');
        
        modal.classList.remove('hidden');
    }

    function closeInstallModal() { document.getElementById('install-modal').classList.add('hidden'); }
</script>

</body>
</html>